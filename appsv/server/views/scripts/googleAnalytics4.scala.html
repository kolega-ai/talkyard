@**
 * Google Analytics 4 integration with security considerations.
 *
 * SECURITY CHALLENGE:
 * Google does not support SRI for their analytics scripts because:
 * 1. The script content changes frequently
 * 2. Google explicitly advises against pinning to specific versions
 *
 * SOLUTION IMPLEMENTED:
 * 1. Load GA with strict CSP controls
 * 2. Monitor for unexpected behavior 
 * 3. Use privacy-focused configuration
 *
 * For maximum security, consider:
 * - Server-side analytics (Plausible, Matomo)
 * - Google Analytics Measurement Protocol (no client JS)
 *@

@import com.debiki.core.ExternalResourceIntegrity.GoogleAnalytics

@(tagId: String)

<!-- Google tag (gtag.js) with enhanced security -->
<script>
(function() {
  // SECURITY: Load GA with error handling and monitoring
  var script = document.createElement('script');
  script.src = '@{GoogleAnalytics.gtagUrl}?id=@tagId';
  script.async = true;
  
  // Monitor for unexpected behavior
  script.onload = function() {
    // Verify expected globals exist
    if (typeof gtag !== 'function') {
      console.error('GA loaded but gtag not defined - possible tampering');
      // Could report this incident for security monitoring
    }
  };
  
  script.onerror = function() {
    console.warn('Google Analytics failed to load');
  };
  
  document.head.appendChild(script);
})();

// Initialize dataLayer with privacy-focused configuration
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '@tagId', {
  'anonymize_ip': true,
  'cookie_flags': 'SameSite=Strict;Secure',
  'allow_google_signals': false,
  'allow_ad_personalization_signals': false
});
</script>
